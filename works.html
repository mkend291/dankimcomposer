<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Works - DANIEL KIM</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">DANIEL S. KIM</a>
            <ul class="nav-menu">
                <li><a href="index.html" class="nav-link">Home</a></li>
                <li><a href="works.html" class="nav-link active">Works</a></li>
                <li><a href="requests.html" class="nav-link">Requests</a></li>
                <li><a href="media-music.html" class="nav-link">Media Music</a></li>
                <li class="dropdown">
                    <a href="#" class="nav-link">More ▾</a>
                    <ul class="dropdown-menu">
                        <li><a href="events.html" class="dropdown-link">Events</a></li>
                        <li><a href="converter.html" class="dropdown-link">Text to Music Converter</a></li>
                        <li><a href="chord-progression.html" class="dropdown-link">Chord Progression Generator</a></li>
                        <li><a href="sunset-bird.html" class="dropdown-link">Sunset Bird</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </nav>

    <main>
        <section class="content">
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 1.5rem; flex-wrap: wrap;">
                <h1 style="margin-bottom: 0;">WORKS</h1>
            </div>
            <p id="works-stats" style="margin-top: 0.25rem; margin-bottom: 0.5rem;">Loading...</p>
            <div style="margin-bottom: 0.5rem;">
                <input type="text" id="works-search" placeholder="Search by title, instrument, or year" style="width: 100%; padding: 0.5rem 1rem; border-radius: 6px; border: 1px solid #569cd6; font-size: 1rem;">
            </div>
            <!-- Filters -->
            <div class="filters">
                <div class="filter-group">
                    <label for="type-filter">Type:</label>
                    <select id="type-filter" onchange="applyFilters()">
                        <option value="all">All</option>
                        <option value="concert">Concert Music</option>
                        <option value="media">Media Music</option>
                        <option value="arrangement">Arrangement</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="instrument-filter">Instrument:</label>
                    <select id="instrument-filter" onchange="applyFilters()">
                        <option value="all">All Instruments</option>
                    </select>
                </div>
            </div>
            
            <!-- Works Container -->
            <div id="works-container">
                <p>Loading works...</p>
            </div>

            <!-- Request Form Overlay -->
            <div id="work-request-overlay" class="request-overlay">
                <div class="request-form-container">
                    <button class="close-btn" onclick="closeWorkRequestForm()">&times;</button>
                    <h2 id="work-form-title">REQUEST WORK</h2>
                    <form id="work-request-form" onsubmit="submitWorkRequest(event)">
                        <input type="hidden" id="work-title" name="work-title">
                        
                        <div class="form-group">
                            <label for="work-name">Name *</label>
                            <input type="text" id="work-name" name="work-name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="work-email">Email *</label>
                            <input type="email" id="work-email" name="work-email" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="work-subject">Subject</label>
                            <input type="text" id="work-subject" name="work-subject" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label for="work-details">Additional Details</label>
                            <textarea id="work-details" name="work-details" rows="6"></textarea>
                        </div>
                        
                        <button type="submit" class="submit-btn">Submit Request</button>
                    </form>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 Daniel S. Kim. All rights reserved.</p>
    </footer>

    <script>
        // Open work request form
        function openWorkRequestForm(title) {
            document.getElementById('work-request-overlay').style.display = 'flex';
            document.getElementById('work-form-title').textContent = 'Request: ' + title;
            document.getElementById('work-title').value = title;
            document.getElementById('work-subject').value = 'Requesting ' + title;
            document.body.style.overflow = 'hidden';
        }

        // Close work request form
        function closeWorkRequestForm() {
            document.getElementById('work-request-overlay').style.display = 'none';
            document.getElementById('work-request-form').reset();
            document.body.style.overflow = 'auto';
        }

        // Submit work request
        function submitWorkRequest(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData);
            
            const subject = encodeURIComponent(data['work-subject']);
            const body = encodeURIComponent(
                `Name: ${data['work-name']}\n` +
                `Email: ${data['work-email']}\n\n` +
                `Additional Details:\n${data['work-details'] || 'None provided'}`
            );
            
            window.location.href = `mailto:dankim291@icloud.com?subject=${subject}&body=${body}`;
            
            closeWorkRequestForm();
        }

        // Close overlay when clicking outside the form
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('work-request-overlay').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeWorkRequestForm();
                }
            });
        });

        // Toggle description expansion
        function toggleDescription(element) {
            const description = element.querySelector('.work-description');
            
            if (!description) return;
            
            if (description.style.display === 'none') {
                description.style.display = 'block';
            } else {
                description.style.display = 'none';
            }
        }
        
        let allWorks = [];
        
        // Load works from CSV
        fetch('WebsiteWorks.csv', { cache: 'no-store' })
            .then(response => response.text())
            .then(csvText => {
                function parseCSV(text) {
                    const rows = [];
                    let currentField = '', currentRow = [], insideQuotes = false;
                    for (let i = 0; i < text.length; i++) {
                        const char = text[i], nextChar = text[i + 1];
                        if (char === '"' && nextChar === '"' && insideQuotes) { currentField += '"'; i++; }
                        else if (char === '"') { insideQuotes = !insideQuotes; }
                        else if (char === ',' && !insideQuotes) { currentRow.push(currentField); currentField = ''; }
                        else if ((char === '\n' || char === '\r') && !insideQuotes) {
                            if (char === '\r' && nextChar === '\n') i++;
                            if (currentField || currentRow.length > 0) { currentRow.push(currentField); rows.push(currentRow); currentRow = []; currentField = ''; }
                        } else { currentField += char; }
                    }
                    if (currentField || currentRow.length > 0) { currentRow.push(currentField); rows.push(currentRow); }
                    return rows;
                }
                const rows = parseCSV(csvText);
                if (rows.length < 2) return;
                const headerRow = rows[0];
                for (let i = 1; i < rows.length; i++) {
                    const values = rows[i];
                    if (values[0] === 'PUBLISHED') {
                        // Map header to value, fallback to '' if missing
                        const work = {};
                        for (let j = 0; j < headerRow.length; j++) {
                            work[headerRow[j]?.trim() || `col${j}`] = values[j] || '';
                        }
                        // Provide legacy fallback for year if missing
                        if (!work['Year'] && work['OrderDate']) {
                            work['Year'] = new Date(work['OrderDate']).getFullYear().toString();
                        }
                        allWorks.push(work);
                    }
                }
                // Sort all works by date (most recent first)
                allWorks.sort((a, b) => new Date(b.OrderDate) - new Date(a.OrderDate));
                // Populate instrument filter
                const instrumentTags = new Set();
                allWorks.forEach(work => {
                    const tags = (work['InstrumentTags'] || '').replace(/\[|\]/g, '').split(',');
                    tags.forEach(tag => {
                        const trimmedTag = tag.trim();
                        if (trimmedTag && trimmedTag.toLowerCase() !== 'media music') {
                            instrumentTags.add(trimmedTag);
                        }
                    });
                });
                const instrumentFilter = document.getElementById('instrument-filter');
                Array.from(instrumentTags).sort().forEach(tag => {
                    const option = document.createElement('option');
                    option.value = tag;
                    option.textContent = tag;
                    instrumentFilter.appendChild(option);
                });
                // Calculate and display stats
                const totalWorks = allWorks.length;
                const totalMinutes = allWorks.reduce((sum, work) => sum + (parseFloat(work['Duration']) || 0), 0);
                const totalHours = (totalMinutes / 60).toFixed(1);
                document.getElementById('works-stats').textContent = `${totalWorks} works • ${totalHours} hours of music`;
                // Display all works
                displayWorks();
            })
            .catch(error => {
                console.error('Error loading works:', error);
                document.getElementById('works-container').innerHTML = '<p>Unable to load works.</p>';
            });
        
        function displayWorks() {
            const container = document.getElementById('works-container');
            const typeFilter = document.getElementById('type-filter').value;
            const instrumentFilter = document.getElementById('instrument-filter').value;
            const searchTerm = document.getElementById('works-search').value.trim().toLowerCase();
            let filteredWorks = allWorks.filter(work => {
                // Parse instrument tags
                const tags = (work['InstrumentTags'] || '').replace(/\[|\]/g, '').split(',').map(t => t.trim());
                // Type filter
                const isMediaMusic = tags.some(tag => tag.toLowerCase() === 'media music');
                const arrangementValue = work['isArrangement'] ? work['isArrangement'].replace(/\[|\]/g, '').trim().toLowerCase() : '';
                const isArrangement = arrangementValue === 'arrangement';
                if (typeFilter === 'concert' && (isMediaMusic || isArrangement)) return false;
                if (typeFilter === 'media' && (!isMediaMusic || isArrangement)) return false;
                if (typeFilter === 'arrangement' && !isArrangement) return false;
                // Instrument filter
                if (instrumentFilter !== 'all') {
                    if (!tags.includes(instrumentFilter)) return false;
                }
                // Search filter
                if (searchTerm) {
                    const inTitle = work['Title'] && work['Title'].toLowerCase().includes(searchTerm);
                    const inDesc = work['Description'] && work['Description'].toLowerCase().includes(searchTerm);
                    const inInstr = work['Instruments'] && work['Instruments'].toLowerCase().includes(searchTerm);
                    if (!inTitle && !inDesc && !inInstr) return false;
                }
                return true;
            });
            if (filteredWorks.length === 0) {
                container.innerHTML = '<p>No works match the selected filters.</p>';
                return;
            }
            container.innerHTML = `
                <div class="works-list">
                    ${filteredWorks.map((work, index) => {
                        const colorClass = `work-color-${index % 2}`;
                        return `
                        <div class="work-item ${colorClass}">
                            <div class="work-main">
                                <div class="work-info">
                                    <h3>${work['Title'] ? work['Title'].toUpperCase() : ''}</h3>
                                    <div class="work-instrumentation" style="font-weight: normal; font-family: inherit;">${work['Instruments'] || ''}</div>
                                    <div class="work-meta" style="font-weight: normal; font-family: inherit; color: #cccccc;">
                                        ${work['Year'] ? `<span class='work-year-text' style='font-weight: normal;'>${work['Year']}</span>` : ''}
                                        ${(work['Year'] && work['Duration']) ? ' • ' : ''}
                                        ${work['Duration'] && work['Duration'].trim() ? `${work['Duration']} min` : ''}
                                    </div>
                                </div>
                                <div class="work-actions">
                                    ${work['Description'] && work['Description'].trim() ? `<button class="action-btn description-btn" onclick="toggleDescription(this.closest('.work-item'))"><i class='fa-solid fa-circle-info'></i> Info</button>` : ''}
                                    ${(work['Video Link'] && work['Video Link'].trim()) || (work['Playlist'] && work['Playlist'].trim()) ? `<a href="${work['Video Link'] && work['Video Link'].trim() ? work['Video Link'] : work['Playlist']}" target="_blank" class="action-btn video-btn"><i class='fab fa-youtube'></i> Video</a>` : ''}
                                    ${work['Buy Link'] && work['Buy Link'].trim() ? `<a href="${work['Buy Link']}" target="_blank" class="action-btn score-btn"><i class='fa-solid fa-dollar-sign'></i> Purchase</a>` : ''}
                                    ${!work['Buy Link'] || !work['Buy Link'].trim() ? `<button class="action-btn request-btn" onclick="openWorkRequestForm('${(work['Title'] || '').replace(/'/g, "\\'")}')"><i class='fa-solid fa-envelope'></i> Request</button>` : ''}
                                </div>
                            </div>
                            ${work['Description'] && work['Description'].trim() ? `<div class="work-description" style="display: none;">${work['Description']}</div>` : ''}
                        </div>
                    `}).join('')}
                </div>
            `;
        }
        // Update works on filter/search
        document.getElementById('type-filter').addEventListener('change', displayWorks);
        document.getElementById('instrument-filter').addEventListener('change', displayWorks);
        document.getElementById('works-search').addEventListener('input', displayWorks);
    </script>
